name: ci
on:
  push:
    branches: [main]
  pull_request:
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.server.outputs.any_changed }}
      cerbos: ${{ steps.cerbos.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: changed files for server
        id: server
        uses: tj-actions/changed-files@v36
        with:
          files: |
            server/**
            .github/workflows/ci.yml
            .github/workflows/ci_server.yml
            .github/workflows/build_deploy_server.yml
      - name: changed files for cerbos
        id: cerbos
        uses: tj-actions/changed-files@v36
        with:
          files: |
            cerbos/**
            policies/**
            .github/workflows/ci.yml
            .github/workflows/ci_cerbos.yml
            .github/workflows/build_deploy_cerbos.yml
  ci-server:
    needs: prepare
    if: needs.prepare.outputs.server == 'true'
    uses: ./.github/workflows/ci_server.yml
  ci-cerbos:
    needs: prepare
    if: needs.prepare.outputs.cerbos == 'true'
    uses: ./.github/workflows/ci_cerbos.yml
  ci:
    runs-on: ubuntu-latest
    needs:
      - ci-server
      - ci-cerbos
    if: '!failure()'
    steps:
      - run: echo OK
  build-deploy-server:
    needs:
      - ci
      - ci-server
    if: ${{ success() && needs.ci-server.result == 'success' && github.event_name == 'push' && github.ref_name == 'main' }}
    uses: ./.github/workflows/build_deploy_server.yml
  build-deploy-cerbos:
    needs:
      - ci
      - ci-cerbos
    if: ${{ success() && needs.ci-cerbos.result == 'success' && github.event_name == 'push' && github.ref_name == 'main' }}
    uses: ./.github/workflows/build_deploy_cerbos.yml
